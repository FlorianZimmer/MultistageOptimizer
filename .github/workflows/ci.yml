name: CI

on:
  push:
  pull_request:

jobs:
  build-and-benchmark:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: microsoft/setup-msbuild@v2
      - name: Build (Release x64)
        run: msbuild MultistageOptimizer.sln /p:Configuration=Release /p:Platform=x64
      - name: Unit tests
        run: |
          $exe = "x64\Release\MultistageOptimizerTests.exe"
          if (!(Test-Path $exe)) { throw "Missing test executable at $exe" }
          & $exe
      - name: Benchmark
        env:
          GIT_HEAD: ${{ github.sha }}
          BENCHMARK_MAX_SECONDS: 10
          BENCHMARK_MAX_MIN_SECONDS: 1
        run: |
          $exe = "x64\Release\MultistageOptimizer.exe"
          if (!(Test-Path $exe)) { throw "Missing executable at $exe" }
          $csv = Join-Path $env:RUNNER_TEMP "benchmark_results.csv"
          $output = & $exe --benchmark --benchmark-config config/benchmark_ci.json --benchmark-threads 1 --benchmark-iterations 1 --benchmark-warmup 1 --benchmark-max-seconds $env:BENCHMARK_MAX_SECONDS --benchmark-csv $csv --no-prompt | Out-String
          $exitCode = $LASTEXITCODE
          $result = $output | ConvertFrom-Json

          if ($result.status -ne "pass") {
            throw "Benchmark status=$($result.status) exitCode=$exitCode`n$output"
          }
          if ([double]$result.timings_seconds.min_max -gt [double]$env:BENCHMARK_MAX_MIN_SECONDS) {
            throw "Performance regression: min_max=$($result.timings_seconds.min_max)s > $env:BENCHMARK_MAX_MIN_SECONDS`s`n$output"
          }
          if ($exitCode -ne 0) {
            throw "Benchmark exited with code $exitCode`n$output"
          }
